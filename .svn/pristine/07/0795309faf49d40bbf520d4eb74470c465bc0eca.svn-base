<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>学员课程进度统计,学校管理员页面</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/admin.css" media="all">
    <script src="/layuiadmin/js/qrcode.js"></script>
    <style type="text/css">
        .officialSealFourth{
            opacity: 1.8;
            transform: rotate(-45deg);
            margin-left: 42%;
            height: 162px;
            border: none;
            margin-top: -11px;
        }
        .officialSealAll{
            opacity: 1.8;
            height: 162px;
            border: none;
            /*width: 50px;*/
            margin-top: 28%;
            /* max-width: 165px; */
            z-index: 9;
            position: absolute;
            background-size: 162px 162px;
            /*background-position-x: -100px;*/
            background-image: url(/layuiadmin/images/hege.png);
            margin-left: 44.7%;
        }
        .layui-table td{
            border:0.5px solid black;
        }
        body,td,th {color: black;}
        .layui-table-cell {
            padding: 0 5px;
        }
        .bodyDiv{
            width: 794px;
            height: 1123px;
            text-align: center;
            margin-left: 15%;
            margin-bottom: 0.6%;
            page-break-before:left;
        }
        .bodyFourthTitle{
            font-family: monospace;
            font-size: 35px;
            position: relative;
            top: 6%;
            font-weight: 700;
        }
        .bodyFourthCodeTitle{
            font-family: monospace;
            font-size: 16px;
            position: relative;
            float: left;
            left: 9%;
            top: 9%;
        }
        .bodyFourthTableDiv{
            position: relative;
            left: 9%;
            top: 9.4%;
            text-align: left;
        }
        .bodyFourthTable{
            table-layout: fixed;
            width: 82%;
        }
        .bodyThirTitle{
            font-family: monospace;
            font-size: 16px;
            position: relative;
            left: 8%;
            top: 6%;
            width: 85%;
        }
        .bodyThirTitleNew{
            font-family: monospace;
            font-size: 16px;
            position: relative;
            left: -1%;
            top: 5%;
            width: 85%;
        }
        .bodyThirTableDiv{
            position: relative;
            left: 8%;
            top: 6.4%;
            width: 85%;
        }
        .tiltFont{
            font-family: initial;
            font-size: 67px;
            font-weight: 500;
            color: rgb(125 125 125 / 16%);
            -ms-transform: rotate(-37deg);
            -moz-transform: rotate(-37deg);
            -webkit-transform: rotate(-37deg);
            position: absolute;
            -o-transform: rotate(-37deg);
            z-index: 2;
            margin-top: 25%;
            /*margin-left: 8%;*/
        }
        .QrcodeHtml{
            width: 120px;
            position: absolute;
            height: 120px;
            margin-top: 20%;
            margin-left: 5%;
        }
        .QrcodeHtmlText{
            position: absolute;
            margin-top: 22%;
            margin-left: 14%;
        }
    </style>
</head>
<body>

<div class="layui-fluid">
    <div class="layui-inline " style="left: 91%;position: fixed">
        <button type="button" class="layui-btn layuiadmin-btn-comm layui-btn-sm" onclick="exportData()">
            <i class="layui-icon layui-icon-export layuiadmin-button-btn"></i>截屏保存
        </button>
    </div>
    <div class="layui-card bodyDiv" >
        <div class="officialSealAll">
            <!--            <img style="height: 162px;margin-top: 50%;max-width: 165px;z-index: 9;position: absolute;" class="officialSealAll" src="/layuiadmin/images/hege.png">-->
        </div>
        <div style="height: 1050px">
            <div class="bodyFourthTitle">培训平台学时证明</div>
            <div class="bodyFourthCodeTitle" id="fourthTitleCode"></div>
            <div class="tiltFont"></div>
            <div class="bodyFourthTableDiv">
                <table class="layui-table bodyFourthTable" style="border:1px solid black;">
                    <tr>
                        <td>姓名</td>
                        <td><p id="fourthStudentName"></p></td>
                    </tr>
                    <tr>
                        <td>证件类型</td>
                        <td><p id="fourthStudentIdCradType"></p></td>
                    </tr>
                    <tr>
                        <td>证件编号</td>
                        <td><p id="fourthStudentIdCrad"></p></td>
                    </tr>
                    <tr>
                        <td>培训机构名称</td>
                        <td><p id="fourthSchoolName"></p></td>
                    </tr>
                    <tr>
                        <td>班级名称</td>
                        <td><p id="fourthClassName"></p></td>
                    </tr>
                    <tr>
                        <td>培训日期</td>
                        <td><p id="fourthStudyTime"></p></td>
                    </tr>
                    <tr>
                        <td>培训类型</td>
                        <td><p id="fourthStudyType"></p></td>
                    </tr>
                    <tr>
                        <td>视频学习时长</td>
                        <td><p id="fourthVideoLength"></p></td>
                    </tr>
                    <!--<tr>
                        <td>习题学习时长</td>
                        <td><p id="fourthQuestionLength"></p></td>
                    </tr>-->
                    <tr>
                        <td>合计在线学习时长</td>
                        <td><p id="fourthTotalLength"></p></td>
                    </tr>
                    <tr>
                        <td style="height: 142px;">
                            <div style="    position: absolute;top: 65%;">
                                <p>培训机构：（盖章）</p>
                                <p id="fourthCreTimeSchool"></p>
                            </div>
                            <!--                            <img style="max-width: 142px;" class="officialSealFourth" src="/layuiadmin/images/hege.png">-->
                        </td>
                        <td>
                            <div style="    position: absolute;top: 65%;">
                                <p>平台：（盖章）</p>
                                <p id="fourthCreTimeAdmin"></p>
                            </div>
                            <img style="max-width: 165px;" class="officialSealFourth" src="/layuiadmin/images/hege.png">
                        </td>
                    </tr>
                </table>
            </div>
            <div class="QrcodeHtml">
                <div id="appQrcode"></div>
            </div>
            <div class="QrcodeHtmlText" >
                <p style="text-align: left;padding-bottom: 5%;">温馨提示：请使用微信扫描该二维码</p>
                <p style="text-align: left;">可验证该学时证明的基本信息是否有效</p>
            </div>
        </div>
    </div>
    <div class="layui-card bodyDiv" >
        <div class="officialSealAll">
            <!--            <img style="height: 162px;margin-top: 50%;max-width: 165px;z-index: 9;position: absolute;" class="officialSealAll" src="/layuiadmin/images/hege.png">-->
        </div>
        <div style="height: 1050px">
            <div class="bodyThirTitle">
                <p style="float: left" id="ThirStudentName"></p>
                <p style="float: right" id="ThirStudentIdCard"></p>
                <img style="height: 162px;max-width: 165px;z-index: 9;position: absolute;" class="officialSealFourth" src="/layuiadmin/images/hege.png">
            </div>
            <div class="tiltFont"></div>
            <div class="bodyThirTableDiv">
                <table class="layui-table" id="thirTable" style="color: black;border:1px solid black;">

                </table>
            </div>
        </div>
    </div>
    <div id="nodeListDivSecond" class="layui-card bodyDiv" style="display: none" >
        <div class="officialSealAll">
            <!--            <img style="height: 162px;margin-top: 50%;max-width: 165px;z-index: 9;position: absolute;" class="officialSealAll" src="/layuiadmin/images/hege.png">-->
        </div>
        <div style="height: 1050px">
            <div class="bodyThirTitleNew">
                <img style="height: 162px;max-width: 165px;z-index: 9;position: absolute;" class="officialSealFourth" src="/layuiadmin/images/hege.png">
            </div>
            <div class="tiltFont"></div>
            <div class="bodyThirTableDiv">
                <table class="layui-table" id="nodeListSecond" style="border-color: black;">

                </table>
            </div>
        </div>
    </div>
    <div id="nodeListDivThird" class="layui-card bodyDiv" style="display: none" >
        <div class="officialSealAll">
            <!--            <img style="height: 162px;margin-top: 50%;max-width: 165px;z-index: 9;position: absolute;" class="officialSealAll" src="/layuiadmin/images/hege.png">-->
        </div>
        <div style="height: 1050px">
            <div class="bodyThirTitleNew">
                <img style="height: 162px;max-width: 165px;z-index: 9;position: absolute;" class="officialSealFourth" src="/layuiadmin/images/hege.png">
            </div>
            <div class="tiltFont"></div>
            <div class="bodyThirTableDiv">
                <table class="layui-table" id="nodeListThird" style="border:1px solid black;">

                </table>
            </div>
        </div>
    </div>
    <div id="nodeListDivFourth" class="layui-card bodyDiv" style="display: none" >
        <div class="officialSealAll">
            <!--            <img style="height: 162px;margin-top: 50%;max-width: 165px;z-index: 9;position: absolute;" class="officialSealAll" src="/layuiadmin/images/hege.png">-->
        </div>
        <div style="height: 1050px">
            <div class="bodyThirTitleNew">
                <img style="height: 162px;max-width: 165px;z-index: 9;position: absolute;" class="officialSealFourth" src="/layuiadmin/images/hege.png">
            </div>
            <div class="tiltFont"></div>
            <div class="bodyThirTableDiv">
                <table class="layui-table" id="nodeListFourth" style="border:1px solid black;">

                </table>
            </div>
        </div>
    </div>

</div>

<script src="/layuiadmin/layui/layui.js"></script>
<!--<script src="https://cdn.bootcdn.net/ajax/libs/exif-js/2.3.0/exif.js"></script>-->
<script>
    layui.config({
        base: '/layuiadmin/' //静态资源所在路径
    }).extend({
        index:'lib/index',
        common:'common',
        $tool:'tool',
        html2canvas: 'layui_ext/html2canvas/html2canvas',
        jspdf: 'layui_ext/jspdf/jspdf.debug'
    }).use(['index','common','excel','$tool','html2canvas','jspdf'], function(exports){
        var $ = layui.$
            ,common = layui.common
            ,$tool = layui.$tool
            ,html2canvas = layui.html2canvas
            ,jspdf = layui.jspdf
            ,admin = layui.admin;

        var queryArgs = $tool.getUrlParams();//获取查询参数
        var studenId = queryArgs.studentId;
        var classId = queryArgs.classId;
        var schoolId = queryArgs.ownerSchoolId;
        var courseId = queryArgs.courseId;
        var stuAndCouId = queryArgs.id;
        var studentName = queryArgs.studentName;
        var headers = layui.admin.getTokenHeader();

        var wxQrcodeUrl = layui.setter.WxPathNew;
        // 设置app二维码 appQrcode
        var userQrcode = new QRCode('appQrcode', {
            text: wxQrcodeUrl+"#/studentPro/"+stuAndCouId,
            width: 120,
            height: 120,
            colorDark : '#000000',
            colorLight : '#ffffff',
            correctLevel : QRCode.CorrectLevel.H
        });

        $(function(){
            init();

        });

        //动态赋值
        function init(){

            var loadIndex =  parent.layer.load(1, {shade: [0.1, '#393D49']});
            admin.req({
                url:layui.setter.basePath +'/society/societyStudentAndCourse/tempFilePdfNew.jsn',
                data:{
                    'stuAndCouId':stuAndCouId
                },
                method:"post",
                success:function (data) {
                    console.log(data.data);
                    var arr = document.getElementsByClassName('tiltFont');
                    $.each(arr, function(i, value) {
                        value.innerText=data.data.conName+'培训平台学时证明专用'
                    });

                    //第四部分
                    fourthData(data.data.fourth);
                    //第五部分
                    fifthData(data.data.fifth);
                    parent.layer.close(loadIndex);
                }
            });
        }

        function fourthData(data){
            //fourthTitleCode
            $('#fourthTitleCode').html('证书编号：'+data.studyProve);
            //fourthStudentName
            $('#fourthStudentName').html(data.studentName);
            //fourthStudentIdCradType
            $('#fourthStudentIdCradType').html('身份证');
            //fourthStudentIdCrad
            $('#fourthStudentIdCrad').html(data.studentIdCardNum);
            //fourthSchoolName
            $('#fourthSchoolName').html(data.schoolName);
            //fourthClassName
            $('#fourthClassName').html(data.className);
            //fourthStudyTime
            $('#fourthStudyTime').html(data.classTimePeriod);
            //fourthStudyType
            $('#fourthStudyType').html(data.courseName);
            //fourthVideoLength
            $('#fourthVideoLength').html(data.studyTimeLength+'分钟');
            //fourthQuestionLength
            // $('#fourthQuestionLength').html(data.questionTimeLength+'分钟');
            //fourthTotalLength
            $('#fourthTotalLength').html(data.totalTimeLength+'分钟');
            var dateStr = '日期：'+common.DateFormat(data.certificateTime,"yyyy年MM月dd日");
            $('#fourthCreTimeSchool').html(dateStr);
            $('#fourthCreTimeAdmin').html(dateStr);
        }


        function page() {
            var index = 0;
            var arr = document.getElementsByClassName('layui-card bodyDiv');
            $.each(arr, function(name, value) {
                if (value.style.display=='' || value.style.display=='block'){
                    index++;
                }
            });
            var officialSealArr = document.getElementsByClassName('officialSealAll');
            var lastWidth = 0;
            $.each(officialSealArr, function(i, value) {
                var height = window.getComputedStyle(value,null).height;
                var onceWidth = (height.split('px')[0])/index;
                value.style.width = onceWidth+"px";
                value.style.backgroundPositionX = lastWidth+"px";
                lastWidth = lastWidth-onceWidth;
            });
            console.log(index);
        }


        function fifthData(data){//21
            var stuName = '姓名：'+data.studentName;
            $('#ThirStudentName').html(stuName);

            var stuIdCard = '身份证号：'+data.studentIdCardNum+'（盖章）';
            $('#ThirStudentIdCard').html(stuIdCard);

            var nodeList = data.nodeList;

            var html = '<tr>\n' +
                '        <td>课程名称</td>\n' +
                '        <td colspan="3">'+data.courseName+'</td>\n' +
                '</tr>\n' +
                ' <tr>\n' +
                '         <td>序号</td>\n' +
                '         <td>课程内容</td>\n' +
                '         <td>课时</td>\n' +
                '         <td>讲师</td>\n' +
                '</tr>';
            var htmlTableSecond = '';
            var htmlTableThird = '';
            var htmlTableFourth = '';
            if(nodeList.length>20){
                $.each(nodeList, function(i,val){
                    var teacherName = val.teacherName;
                    if(teacherName==null||$.trim(teacherName)==""){
                        teacherName = '无';
                    }
                    if(i<=20){
                        html = html+'<tr>\n' +
                            '   <td>'+Number(i+1)+'</td>\n' +
                            '   <td>'+val.nodeName+'</td>\n' +
                            '   <td>1</td>\n' +
                            '   <td>'+teacherName+'</td>\n' +
                            '</tr>';
                    }else if(i>=21 & i<=41){
                        htmlTableSecond = htmlTableSecond+'<tr>\n' +
                            '   <td style="width: 18.7%;">'+Number(i+1)+'</td>\n' +
                            '   <td style="width: 49.8%;">'+val.nodeName+'</td>\n' +
                            '   <td style="width: 18.7%;">1</td>\n' +
                            '   <td >'+teacherName+'</td>\n' +
                            '</tr>';
                    }else if(i>=42 & i<=62){
                        htmlTableThird = htmlTableThird+'<tr>\n' +
                            '   <td style="width: 18.7%;">'+Number(i+1)+'</td>\n' +
                            '   <td style="width: 49.8%;">'+val.nodeName+'</td>\n' +
                            '   <td style="width: 18.7%;">1</td>\n' +
                            '   <td>'+teacherName+'</td>\n' +
                            '</tr>';
                    }

                });

            }
            $('#thirTable').html(html);
            if(htmlTableSecond!=''){
                $('#nodeListDivSecond').css('display','block');
                $('#nodeListSecond').html(htmlTableSecond);
            }
            if(htmlTableThird!=''){
                $('#nodeListDivThird').css('display','block');
                $('#nodeListThird').html(htmlTableThird);

            }
            if(htmlTableFourth!=''){
                $('#nodeListDivFourth').css('display','block');
                $('#nodeListFourth').html(htmlTableFourth);
            }
            page();
        }
        exportData = function () {
            window.pageYOffset = 0;
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            var pdf = new jsPDF('', 'pt', 'a4');
            var flag1 = false;
            var pageData1;
            var imgHeight1;
            html2canvas(document.getElementsByClassName('layui-card bodyDiv')[0],{useCORS:true,allowTaint : false, taintTest: true,scale: 2}).then(function (canvas) {
                var contentWidth = canvas.width;
                var contentHeight = canvas.height;
                imgHeight1 = 592.28/contentWidth * contentHeight;
                pageData1 = canvas.toDataURL('image/jpeg', 1.0);
                flag1 = true;
            })
            var flag2 = false;
            var pageData2;
            var imgHeight2;
            html2canvas(document.getElementsByClassName('layui-card bodyDiv')[1],{useCORS:true,allowTaint : false, taintTest: true,scale: 2}).then(function (canvas) {
                var contentWidth = canvas.width;
                var contentHeight = canvas.height;
                imgHeight2 = 592.28/contentWidth * contentHeight;
                pageData2 = canvas.toDataURL('image/jpeg', 1.0);
                flag2 = true;
            })
            var flag3 = false;
            var pageData3;
            var imgHeight3;
            var indexFlag3 = false;
            if (document.getElementsByClassName('layui-card bodyDiv')[4].style!='none'){
                html2canvas(document.getElementsByClassName('layui-card bodyDiv')[2],{useCORS:true,allowTaint : false, taintTest: true,scale: 2}).then(function (canvas) {
                    var contentWidth = canvas.width;
                    var contentHeight = canvas.height;
                    imgHeight3 = 592.28/contentWidth * contentHeight;
                    pageData3 = canvas.toDataURL('image/jpeg', 1.0);
                    flag3 = true;
                })
            }else {
                indexFlag3 = true;
                flag3 = true;
            }
            var flag4 = false;
            var pageData4;
            var imgHeight4;
            var indexFlag4 = false;
            if (document.getElementsByClassName('layui-card bodyDiv')[4].style!='none'){
                html2canvas(document.getElementsByClassName('layui-card bodyDiv')[3],{useCORS:true,allowTaint : false, taintTest: true,scale: 2}).then(function (canvas) {
                    var contentWidth = canvas.width;
                    var contentHeight = canvas.height;
                    imgHeight4 = 592.28/contentWidth * contentHeight;
                    pageData4 = canvas.toDataURL('image/jpeg', 1.0);
                    flag4 = true;
                })
            }else {
                indexFlag4 = true;
                flag4 = true;
            }
            var flag5 = false;
            var pageData5;
            var imgHeight5;
            var indexFlag5 = false;
            if (document.getElementsByClassName('layui-card bodyDiv')[4].style!='none'){
                html2canvas(document.getElementsByClassName('layui-card bodyDiv')[4],{useCORS:true,allowTaint : false, taintTest: true,scale: 2}).then(function (canvas) {
                    var contentWidth = canvas.width;
                    var contentHeight = canvas.height;
                    imgHeight5 = 592.28/contentWidth * contentHeight;
                    pageData5 = canvas.toDataURL('image/jpeg', 1.0);
                    flag5 = true;
                })
            }else {
                indexFlag5 = true;
                flag5 = true;
            }

            var downLoadPdf = setInterval(function () {
                if(flag1 && flag2 && flag3 && flag4){
                    pdf.addImage(pageData1, 'JPEG', 0, 0, 595.28, imgHeight1 );
                    pdf.addPage();
                    pdf.addImage(pageData2, 'JPEG', 0, 0, 595.28, imgHeight2 );
                    if (!indexFlag3){
                        pdf.addPage();
                        pdf.addImage(pageData3, 'JPEG', 0, 0, 595.28, imgHeight3);
                    }
                    if (!indexFlag4){
                        pdf.addPage();
                        pdf.addImage(pageData4, 'JPEG', 0, 0, 595.28, imgHeight4 );
                    }
                    pdf.save(studentName+'学时证明.pdf');
                    clearInterval(downLoadPdf);
                    // 将pdf输入为base格式的字符串
                    var time = common.DateFormat(new Date(),"yyyy_MM_dd");
                    var buffer = pdf.output("datauristring")
                    // 将base64格式的字符串转换为file文件
                    var myfile = dataURLtoFile(buffer, time+studentName+'学时证明.pdf');
                    var formdata = new FormData();
                    formdata.append('file', myfile);
                    formdata.append('fileType', 'STUDY_TIME_PROVE');
                    admin.req({
                        url:layui.setter.basePath +'/society/common/uploadPDFFile.jsn',
                        method: "POST",
                        data: formdata,
                        headers:headers,
                        datatype: 'json' ,
                        cache: false ,
                        traditional: true ,
                        contentType: false ,
                        processData: false ,
                        success:function (data) {
                            layer.msg('保存完成');
                        }
                    });
                }
            },300)

        }

        //将base64转换为文件对象
        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(',');
            var mime = arr[0].match(/:(.*?);/)[1];
            var bstr = atob(arr[1]);
            var n = bstr.length;
            var u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            //转换成file对象
            return new File([u8arr], filename, {type:mime});
            //转换成成blob对象
            //return new Blob([u8arr],{type:mime});
        }
    });

</script>
</body>
</html>

